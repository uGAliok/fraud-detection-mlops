# ML Fraud Detection Service

Датасеты предоставлены в рамках соревнования [TETA ML 1. 2025](https://www.kaggle.com/competitions/teta-ml-1-2025)

Сервис для автоматического обнаружения мошеннических транзакций в режиме батчевого скоринга. Обрабатывает CSV-файлы из указанной директории с использованием предобученной `LightGBM` модели. 

## Архитектура решения
```
├── .gitignore
├── Dockerfile
├── README.md
├── app/
│ └── app.py # Ядро сервиса с обработкой событий и запуском скоринга
├── models/
│ └── mylightgbm_model.pkl # Предобученная LightGBM модель
├── src/
│ ├── preprocessing.py # Пайплайн обработки данных
│ └── scorer.py # Модуль прогнозирования
└── train_data/
│ └── train.csv # Данные для обучения (reference)
└── input/ # Директория для загрузки файлов на скоринг
└── output/ # Директория с результатами скоринга (csv + графики + json)
```

## Результаты скоринга
Для каждого обработанного файла создаются:
- predictions_<timestamp>_<filename>.csv — предсказания в формате sample_submission
- feature_importances_<timestamp>_<filename>.json — топ-5 фич по важности (LightGBM gain)
- scores_density_<timestamp>_<filename>.png — график плотности предсказанных вероятностей


## Ключевые особенности

### Пайплайн обработки данных (`preprocessing.py`)
1. **Временные признаки**:
   - Извлечение  года, месяца, дня, дня недели и часа
   - Парсинг `transaction_time` с обработкой некорректных значений
   
2. **Геопространственные расчеты**:
   - Вычисление расстояния между пользователем и мерчантом по формуле гаверсинуса

3. **Категориальные переменные**:
   - Используется `LabelEncoder`, обученный на train.csv
   - Поддержка `<UNK>` для неизвестных категорий (устойчивость при новых значениях)

4. **Числовые признаки**:
   - Импутация пропусков средними значениями
   - Логарифмирование `(log(x + 1))` для сглаживания распределения

### Модельный слой (`scorer.py`)
- Порог классификации: 0.686 (оптимально подобран)
- Автоматическая загрузка модели при инициализации
- Батчевая обработка через `predict_proba`

### Логирование
- `/app/logs/service.log` — основной лог-файл
- `stdout` — дублирование логов в консоль при запуске контейнера
- Уровни:
  - `INFO`: Основные этапы обработки
  - `DEBUG`: Детали преобразования данных
  - `ERROR`: Критические сбои с трейсбэками

## Быстрый старт

### Требования
- Docker 20.10+
- 2 ГБ свободного места
- Порты: только файловая система

### Запуск сервиса

1. Скачайте файл `train.csv` из соревнования https://www.kaggle.com/competitions/teta-ml-1-2025 и разместите в директории `./train_data`
2. Соберите образ
```bash
docker build -t fraud_detector .
```
3. Запустите контейнер с монтированием томов
```bash
docker run -it --rm -v ./input:/app/input \
                    -v ./output:/app/output \
                    fraud_detector
```
4. После запуска сервиса (появления в логах сообщения: `__main__ - INFO - File observer started`) можно приступать к скорингу данных:
 - Разместите файл формата test.csv из соревнования https://www.kaggle.com/competitions/teta-ml-1-2025 в директории `./input`
 - Подождите выполнения препроцессинга и скоринга датасета (в логах будет указано название сформированного файла)
 - Полученный результат моделирования, файл с топ-5 feature importances b png файла с графиком плотности распределения предсказанных моделью скоров будут выгружены сервисом в директорию `./output`

## Примечания
- Модель работает только для инференса, обучение происходит заранее.
- Обработка происходит на CPU